// js/login.js

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("login-form");
  const nameInput = document.getElementById("name");
  const historyInput = document.getElementById("history");
  const avatarInput = document.getElementById("avatar");
  const saveJsonBtn = document.getElementById("save-json");
  const loadJsonInput = document.getElementById("load-json");
  const passportEl = document.querySelector(".passport");
  const serialSpan = document.getElementById("passport-serial");

  // Bloque de la foto en el pasaporte
  const photoFrame = document.getElementById("photo-frame");
  const avatarPreview = document.getElementById("avatar-preview");
  const avatarPlaceholder = document.getElementById("avatar-placeholder");

  // Overlay de recorte
  const cropOverlay = document.getElementById("avatar-crop-overlay");
  const cropImage = document.getElementById("avatar-crop-image");
  const zoomInput = document.getElementById("avatar-zoom");
  const cancelCropBtn = document.getElementById("avatar-cancel");
  const applyCropBtn = document.getElementById("avatar-apply");

  let avatarDataUrl = null;            // imagen final (base64)
  let editingAvatarDataUrl = null;     // imagen que se está recortando
  let currentAvatarTransform = "";     // transform usado en el pasaporte

  // Estado del recorte
  const cropState = {
    scale: 1,
    offsetX: 0,
    offsetY: 0,
  };

  // ==============================
  //   SERIAL DEL PASAPORTE
  // ==============================
  if (serialSpan) {
    let serial = localStorage.getItem("dwjc2_serial");

    if (!serial) {
      const random = Math.floor(Math.random() * 10000); // 0-9999
      const padded = String(random).padStart(4, "0");
      serial = `DW-JC2-${padded}`;
      localStorage.setItem("dwjc2_serial", serial);
    }

    serialSpan.textContent = serial;
  }

  // ==============================
  //   UTIL: APLICAR FOTO AL PASAPORTE
  // ==============================
  function setAvatarPreview(src, transform) {
    if (!avatarPreview || !photoFrame) return;

    avatarDataUrl = src;

    avatarPreview.src = src;
    avatarPreview.style.display = "block";
    photoFrame.classList.add("has-avatar");
    if (avatarPlaceholder) {
      avatarPlaceholder.style.display = "none";
    }

    if (transform) {
      currentAvatarTransform = transform;
      avatarPreview.style.transform = transform;
    } else if (currentAvatarTransform) {
      avatarPreview.style.transform = currentAvatarTransform;
    } else {
      avatarPreview.style.transform = "translate(0px, 0px) scale(1)";
    }
  }

  // ==============================
  //   CROP: ACTUALIZAR TRANSFORM
  // ==============================
  function updateCropTransform() {
    if (!cropImage) return;
    cropImage.style.transform = `translate(${cropState.offsetX}px, ${cropState.offsetY}px) scale(${cropState.scale})`;
  }

  // Abrir el recortador con una imagen dada
  function openCropper(dataUrl) {
    if (!cropOverlay || !cropImage || !zoomInput) {
      // fallback: si no existe el overlay, solo mostramos la imagen
      setAvatarPreview(dataUrl);
      return;
    }

    editingAvatarDataUrl = dataUrl;

    cropState.scale = 1;
    cropState.offsetX = 0;
    cropState.offsetY = 0;
    zoomInput.value = "1";
    updateCropTransform();

    cropImage.src = dataUrl;
    cropOverlay.classList.add("open");
  }

  // ==============================
  //   AVATAR: SUBIR IMAGEN
  // ==============================
  if (avatarInput) {
    avatarInput.addEventListener("change", () => {
      const file = avatarInput.files[0];
      if (!file) {
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const url = e.target.result;
        openCropper(url);
      };
      reader.readAsDataURL(file);
    });
  }

  // ==============================
  //   CROP: CONTROLES (ZOOM + DRAG)
  // ==============================
  if (zoomInput) {
    zoomInput.addEventListener("input", () => {
      const value = parseFloat(zoomInput.value) || 1;
      cropState.scale = value;
      updateCropTransform();
    });
  }

if (cropImage) {
  let dragging = false;
  let startX = 0;
  let startY = 0;
  let baseX = 0;
  let baseY = 0;

  const endDrag = (e) => {
    if (!dragging) return;
    dragging = false;
    try {
      cropImage.releasePointerCapture(e.pointerId);
    } catch (_) {}
    cropImage.style.cursor = "grab";
  };

  cropImage.addEventListener("pointerdown", (e) => {
    dragging = true;
    cropImage.setPointerCapture(e.pointerId);
    cropImage.style.cursor = "grabbing";
    startX = e.clientX;
    startY = e.clientY;
    baseX = cropState.offsetX;
    baseY = cropState.offsetY;
  });

  cropImage.addEventListener("pointermove", (e) => {
    if (!dragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    cropState.offsetX = baseX + dx;
    cropState.offsetY = baseY + dy;
    updateCropTransform();
  });

  cropImage.addEventListener("pointerup", endDrag);
  cropImage.addEventListener("pointercancel", endDrag);
  cropImage.addEventListener("pointerleave", endDrag);
}


  if (cancelCropBtn && cropOverlay) {
    cancelCropBtn.addEventListener("click", () => {
      cropOverlay.classList.remove("open");
      // no cambiamos nada si cancela
    });
  }

  if (applyCropBtn && cropOverlay && cropImage) {
    applyCropBtn.addEventListener("click", () => {
      cropOverlay.classList.remove("open");
      const transform = cropImage.style.transform || "";
      setAvatarPreview(editingAvatarDataUrl, transform);
      // si quieres guardar el transform para el JSON:
      currentAvatarTransform = transform;
    });
  }

  // ==============================
  //   GUARDAR PERSONAJE COMO JSON
  // ==============================
  if (saveJsonBtn) {
    saveJsonBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      const history = historyInput.value.trim();
      const serial = localStorage.getItem("dwjc2_serial") || null;

      if (!name || !history) {
        alert("Primero completa al menos nombre e historia para guardar.");
        return;
      }

      const player = {
        name,
        history,
        avatarDataUrl,
        avatarTransform: currentAvatarTransform || null,
        serial,
      };

      const blob = new Blob([JSON.stringify(player, null, 2)], {
        type: "application/json",
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `personaje-${name || "avatar"}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }

  // ==============================
  //   CARGAR PERSONAJE DESDE JSON
  // ==============================
  if (loadJsonInput) {
    loadJsonInput.addEventListener("change", () => {
      const file = loadJsonInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.name) nameInput.value = data.name;
          if (data.history) historyInput.value = data.history;

          if (data.avatarDataUrl) {
            avatarDataUrl = data.avatarDataUrl;
            currentAvatarTransform = data.avatarTransform || "";
            setAvatarPreview(avatarDataUrl, currentAvatarTransform);
          }

          if (data.serial && serialSpan) {
            serialSpan.textContent = data.serial;
            localStorage.setItem("dwjc2_serial", data.serial);
          }

          alert("Personaje cargado correctamente.");
        } catch (err) {
          console.error(err);
          alert("El archivo no es un JSON válido de personaje.");
        }
      };
      reader.readAsText(file);
    });
  }

  // ==============================
  //   SUBMIT: SELLAR Y ENTREGAR PASAPORTE
  // ==============================
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const name = nameInput.value.trim();
      const history = historyInput.value.trim();
      const serial = localStorage.getItem("dwjc2_serial") || null;

      if (!name || !history) {
        alert("Por favor completa nombre e historia.");
        return;
      }

      const player = {
        name,
        history,
        avatarDataUrl,
        avatarTransform: currentAvatarTransform || null,
        serial,
        createdAt: new Date().toISOString(),
      };

      // Guardamos en localStorage para usarlo en el chat
      localStorage.setItem("dwjc2_player", JSON.stringify(player));

      // Desactivar botón para evitar dobles clics
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "Entregando pasaporte...";
      }

      // Si no encontramos el pasaporte por alguna razón, simplemente redirigimos
      if (!passportEl) {
        window.location.href = "chat.html";
        return;
      }

      // 1) Mostrar el sello de APROBADO
      passportEl.classList.add("passport--approved");

      // 2) Un poco después, cerrar el pasaporte
      setTimeout(() => {
        passportEl.classList.add("passport--closing");
      }, 900);

      // 3) Cuando termina la animación, pasamos al chat
      setTimeout(() => {
        window.location.href = "chat.html";
      }, 3200);
    });
  }
});
